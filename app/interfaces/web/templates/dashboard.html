{% extends "base.html" %}

{% block title %}Dashboard - Palette Transfer{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .upload-area:hover { border-color: #3498db; }
    .upload-area.dragover { border-color: #3498db; background: #f0f8ff; }
    .image-preview {
        max-width: 100%;
        max-height: 300px;
        margin-top: 1rem;
        border-radius: 4px;
    }
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .result-item {
        text-align: center;
    }
    .result-item img {
        max-width: 100%;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    .slider-group { margin: 1rem 0; }
    .slider-group input[type="range"] {
        width: 100%;
        padding: 0;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    .loading.active { display: block; }
    #result-container { display: none; }
    #result-container.active { display: block; }
</style>
{% endblock %}

{% block content %}
<h1>Transfer Dashboard</h1>

<div class="card">
    <h3>Upload Images</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <label>Source (palette to copy)</label>
            <div class="upload-area" id="source-upload">
                <p>Click or drag image here</p>
                <input type="file" id="source-input" accept="image/*" style="display: none;">
                <img id="source-preview" class="image-preview" style="display: none;">
            </div>
        </div>
        <div>
            <label>Target (image to recolor)</label>
            <div class="upload-area" id="target-upload">
                <p>Click or drag image here</p>
                <input type="file" id="target-input" accept="image/*" style="display: none;">
                <img id="target-preview" class="image-preview" style="display: none;">
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h3>Transfer Settings</h3>
    <div class="controls">
        <div class="form-group">
            <label for="method">Method</label>
            <select id="method">
                <option value="skintone">Skin-Tone Transfer</option>
                <option value="reinhard">Reinhard (Classic)</option>
                <option value="hybrid">Hybrid</option>
                <option value="optimized">Optimized</option>
            </select>
        </div>
        <div class="form-group">
            <label for="resize">Image Size</label>
            <select id="resize">
                <option value="100">Original (100%)</option>
                <option value="50" selected>Half (50%) - Recommended</option>
                <option value="25">Quarter (25%) - Fast</option>
                <option value="1080">Max 1080p</option>
                <option value="720">Max 720p</option>
            </select>
        </div>
    </div>

    <div id="skintone-params">
        <div class="controls">
            <div class="slider-group">
                <label>Skin Blend: <span id="skin-blend-val">0.9</span></label>
                <input type="range" id="skin-blend" min="0" max="1" step="0.1" value="0.9">
            </div>
            <div class="slider-group">
                <label>Hair Blend: <span id="hair-blend-val">0.5</span></label>
                <input type="range" id="hair-blend" min="0" max="1" step="0.1" value="0.5">
            </div>
            <div class="slider-group">
                <label>Background Blend: <span id="bg-blend-val">0.3</span></label>
                <input type="range" id="bg-blend" min="0" max="1" step="0.1" value="0.3">
            </div>
        </div>
    </div>

    <div style="margin-top: 1.5rem;">
        <button id="transfer-btn" class="btn">Transfer Palette</button>
        <button id="compare-btn" class="btn btn-secondary">Compare All Methods</button>
        <span id="time-estimate" style="margin-left: 1rem; color: #666;"></span>
    </div>
</div>

<div class="loading" id="loading">
    <p>Processing... <span id="loading-estimate"></span></p>
</div>

<div class="card" id="result-container">
    <h3>Result</h3>
    <div id="result-content"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Image dimensions storage for time estimation
    const imageDimensions = { source: null, target: null };
    const imageDataUrls = { source: null, target: null };
    const MS_PER_MEGAPIXEL = 3000; // ~3 seconds per megapixel based on benchmarks

    // Calculate resized dimensions based on resize option
    function getResizedDimensions(origW, origH) {
        const resizeOption = document.getElementById('resize').value;
        let newW = origW, newH = origH;

        if (resizeOption === '100') {
            // Original size
            return { w: origW, h: origH };
        } else if (resizeOption === '50') {
            newW = Math.round(origW * 0.5);
            newH = Math.round(origH * 0.5);
        } else if (resizeOption === '25') {
            newW = Math.round(origW * 0.25);
            newH = Math.round(origH * 0.25);
        } else {
            // Max dimension options (1080, 720)
            const maxDim = parseInt(resizeOption);
            const maxOrig = Math.max(origW, origH);
            if (maxOrig > maxDim) {
                const scale = maxDim / maxOrig;
                newW = Math.round(origW * scale);
                newH = Math.round(origH * scale);
            }
        }
        return { w: newW, h: newH };
    }

    // Resize image using canvas, returns Promise<Blob>
    function resizeImage(dataUrl, targetW, targetH) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, targetW, targetH);
                canvas.toBlob(resolve, 'image/jpeg', 0.92);
            };
            img.src = dataUrl;
        });
    }

    function updateTimeEstimate() {
        const estimate = document.getElementById('time-estimate');
        if (imageDimensions.source && imageDimensions.target) {
            // Calculate resized dimensions
            const srcResized = getResizedDimensions(imageDimensions.source.w, imageDimensions.source.h);
            const tgtResized = getResizedDimensions(imageDimensions.target.w, imageDimensions.target.h);
            const sourceMp = (srcResized.w * srcResized.h) / 1_000_000;
            const targetMp = (tgtResized.w * tgtResized.h) / 1_000_000;
            const totalMp = sourceMp + targetMp;
            const estimatedMs = totalMp * MS_PER_MEGAPIXEL;
            const estimatedSec = Math.round(estimatedMs / 1000);
            const origMp = ((imageDimensions.source.w * imageDimensions.source.h) +
                           (imageDimensions.target.w * imageDimensions.target.h)) / 1_000_000;
            if (totalMp < origMp) {
                estimate.textContent = `(Est. ~${estimatedSec}s for ${totalMp.toFixed(1)}MP, resized from ${origMp.toFixed(1)}MP)`;
            } else {
                estimate.textContent = `(Est. ~${estimatedSec}s for ${totalMp.toFixed(1)}MP)`;
            }
        } else {
            estimate.textContent = '';
        }
    }

    // File upload handling
    function setupUpload(uploadId, inputId, previewId, imageType) {
        const upload = document.getElementById(uploadId);
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);

        upload.addEventListener('click', () => input.click());
        upload.addEventListener('dragover', (e) => {
            e.preventDefault();
            upload.classList.add('dragover');
        });
        upload.addEventListener('dragleave', () => upload.classList.remove('dragover'));
        upload.addEventListener('drop', (e) => {
            e.preventDefault();
            upload.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                // Use DataTransfer to properly assign files (input.files is read-only)
                const dt = new DataTransfer();
                for (const file of e.dataTransfer.files) {
                    dt.items.add(file);
                }
                input.files = dt.files;
                showPreview(input.files[0], preview, imageType);
            }
        });
        input.addEventListener('change', () => {
            if (input.files.length) showPreview(input.files[0], preview, imageType);
        });
    }

    function showPreview(file, previewEl, imageType) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewEl.src = e.target.result;
            previewEl.style.display = 'block';
            // Store data URL for later resizing
            imageDataUrls[imageType] = e.target.result;
            // Get image dimensions for time estimate
            const img = new Image();
            img.onload = () => {
                imageDimensions[imageType] = { w: img.width, h: img.height };
                updateTimeEstimate();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    setupUpload('source-upload', 'source-input', 'source-preview', 'source');
    setupUpload('target-upload', 'target-input', 'target-preview', 'target');

    // Slider value display
    ['skin-blend', 'hair-blend', 'bg-blend'].forEach(id => {
        const slider = document.getElementById(id);
        const display = document.getElementById(id + '-val');
        slider.addEventListener('input', () => display.textContent = slider.value);
    });

    // Show/hide skintone params
    document.getElementById('method').addEventListener('change', (e) => {
        document.getElementById('skintone-params').style.display =
            e.target.value === 'skintone' ? 'block' : 'none';
    });

    // Update estimate when resize option changes
    document.getElementById('resize').addEventListener('change', updateTimeEstimate);

    // Transfer button
    document.getElementById('transfer-btn').addEventListener('click', async () => {
        if (!imageDataUrls.source || !imageDataUrls.target) {
            alert('Please upload both source and target images');
            return;
        }

        // Show loading with estimate
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-container').style.display = 'none';

        // Calculate resized dimensions and show estimate
        const srcResized = getResizedDimensions(imageDimensions.source.w, imageDimensions.source.h);
        const tgtResized = getResizedDimensions(imageDimensions.target.w, imageDimensions.target.h);
        const loadingEstimate = document.getElementById('loading-estimate');
        const sourceMp = (srcResized.w * srcResized.h) / 1_000_000;
        const targetMp = (tgtResized.w * tgtResized.h) / 1_000_000;
        const totalMp = sourceMp + targetMp;
        const estimatedSec = Math.round((totalMp * MS_PER_MEGAPIXEL) / 1000);
        loadingEstimate.textContent = `(~${estimatedSec}s estimated)`;

        try {
            // Resize images client-side
            const [sourceBlob, targetBlob] = await Promise.all([
                resizeImage(imageDataUrls.source, srcResized.w, srcResized.h),
                resizeImage(imageDataUrls.target, tgtResized.w, tgtResized.h)
            ]);

            const formData = new FormData();
            formData.append('source', sourceBlob, 'source.jpg');
            formData.append('target', targetBlob, 'target.jpg');
            formData.append('method', document.getElementById('method').value);
            formData.append('skin_blend', document.getElementById('skin-blend').value);
            formData.append('hair_blend', document.getElementById('hair-blend').value);
            formData.append('bg_blend', document.getElementById('bg-blend').value);

            const response = await fetch('/api/transfer', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                const resultHtml = `
                    <div class="result-grid">
                        <div class="result-item">
                            <p><strong>Original</strong></p>
                            <img src="${document.getElementById('target-preview').src}">
                        </div>
                        <div class="result-item">
                            <p><strong>Result (${data.method})</strong></p>
                            <img src="${data.result}">
                            <p><small>${data.processing_time_ms}ms | ${srcResized.w}x${srcResized.h} + ${tgtResized.w}x${tgtResized.h}</small></p>
                        </div>
                    </div>
                `;
                document.getElementById('result-content').innerHTML = resultHtml;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result-container').style.display = 'block';
                document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
            } else {
                document.getElementById('loading').style.display = 'none';
                alert('Error: ' + data.error);
            }
        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            alert('Request failed: ' + err.message);
        }
    });

    // Compare button
    document.getElementById('compare-btn').addEventListener('click', async () => {
        const sourceInput = document.getElementById('source-input');
        const targetInput = document.getElementById('target-input');

        if (!sourceInput.files.length || !targetInput.files.length) {
            alert('Please upload both source and target images');
            return;
        }

        const formData = new FormData();
        formData.append('source', sourceInput.files[0]);
        formData.append('target', targetInput.files[0]);

        document.getElementById('loading').classList.add('active');
        document.getElementById('result-container').classList.remove('active');

        try {
            const response = await fetch('/api/compare', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                let html = '<div class="result-grid">';
                html += `<div class="result-item"><p><strong>Original</strong></p><img src="${data.results.original}"></div>`;

                for (const [method, result] of Object.entries(data.results)) {
                    if (method === 'original') continue;
                    if (result.error) {
                        html += `<div class="result-item"><p><strong>${method}</strong></p><p style="color:red;">${result.error}</p></div>`;
                    } else {
                        html += `<div class="result-item"><p><strong>${method}</strong></p><img src="${result.image}"><p><small>${result.time_ms}ms</small></p></div>`;
                    }
                }
                html += '</div>';

                document.getElementById('result-content').innerHTML = html;
                document.getElementById('result-container').classList.add('active');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (err) {
            alert('Request failed: ' + err.message);
        } finally {
            document.getElementById('loading').classList.remove('active');
        }
    });
</script>
{% endblock %}
